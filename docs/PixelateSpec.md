
# 📐 Pixelate Converter 技術仕様

TinyPixel Studio のドット絵変換（Pixelate）機能は、高画質な画像を低解像度のドット絵へと変換するための高度な画像処理パイプラインを備えています。

## 1. 処理パイプライン概要

変換は以下の3つの主要フェーズを経て実行されます。

### A. 幾何学的リサイズ (Geometry Phase)
入力画像をターゲットのドット解像度（例: 64x64）に変換します。
- **補間アルゴリズム**: 最近傍補間（Nearest Neighbor）
  - 通常のバイリニア補間等とは異なり、中間色を生成せずに元のピクセルをサンプリングするため、ドット絵特有のエッジが維持されます。
- **リサイズモード**:
  - `COVER`: アスペクト比を維持しつつ、指定範囲を埋めるように切り抜きます。
  - `CONTAIN`: 全体が収まるように配置し、余白を背景色で埋めます。
  - `STRETCH`: 縦横比を無視してキャンバス全体に引き延ばします。
- **アンカー指定**: `COVER` や `CONTAIN` の際、どの位置を基準にするかを9方向から選択可能です。

### B. 色量子化 (Quantization Phase)
フルカラー（1677万色）のピクセル情報を、指定された限られた色数（8〜256色）へと削減します。
- **アルゴリズム**: Median-Cut法
  1. すべてのピクセル色をRGB空間にプロット。
  2. 色の範囲が最大の軸でソートし、中央値（Median）で分割。
  3. 指定されたパレット数に達するまでこの分割を再帰的に繰り返す。
  4. 最終的な各立方体の平均色をパレットカラーとして採用。

### C. 誤差拡散ディザリング (Dithering Phase)
少ない色数で擬似的なグラデーションや中間色を表現します。
- **アルゴリズム**: Floyd-Steinberg法
  - 現在のピクセルで発生した「本来の色」と「パレット近似色」の差分（誤差）を計算。
  - その誤差を、右(7/16)、左下(3/16)、真下(5/16)、右下(1/16)の未処理ピクセルに分配します。

## 2. 実装上の工夫

- **非同期処理**: 画像処理は計算負荷が高いため、UIスレッドをブロックしないように `Promise` ベースで処理されます。
- **デバウンス (Debouncing)**: 設定変更のたびにリアルタイムプレビューを更新しますが、250msの待機時間を設けることで過剰な再計算を抑止しています。
- **Canvas `willReadFrequently`**: `getImageData` を多用するため、ブラウザの最適化を促すフラグを有効にしています。
- **透明度の扱い**: アルファ値が一定以下のピクセルは「透明」として扱い、パレット生成のサンプリングから除外することで、透明背景のドット絵を正しく生成します。

## 3. ユーザーパラメータ

| パラメータ | 説明 | 推奨値 |
| :--- | :--- | :--- |
| Width/Height | 出力されるドットの解像度 | 16〜128 |
| Palette Size | 使用する最大色数 | 16〜64 |
| Dither | ディザリングの有無 | グラデーションがある場合はON |
| BG Color | 背景の塗りつぶし色 | 透明（デフォルト） |

---

あなたはシニアフロントエンドエンジニア兼、画像編集アプリの実装担当です。  
Web（ブラウザ）上の画像アプリに「ドット絵変換（Pixelate）」機能を実装してください。  
実装に必要な設計・仕様・状態管理・アルゴリズム・UI・テストを、コードを一切書かずに具体化して提示してください。  
（擬似コードも禁止。式やロジックは文章と箇条書きで表現する）

# ゴール

ユーザーが画像を選び、設定を選択して「64×64 のドット絵 PNG」を生成できる。  
生成結果はプレビュー表示でき、ダウンロードできる。

# 前提（座標系・概念）

- 入力画像（src）は幅/高さを持つ。
- 出力画像（dst）は幅/高さ（デフォルト 64×64）を持つ。
- 「アンカー（3×3）」は、切り抜き/配置の基準位置（左上/上/右上/左/中央/右/左下/下/右下）を意味する。
- 画像の加工処理は UI スレッドを塞がない（重い場合は Web Worker 等の設計を含める）。

# UI 仕様：ドキュメントサイズ変更ダイアログと似た構造

以下の構成でダイアログを設計する。

## 1) サイズ

- 出力幅 width（初期 64）
- 出力高さ height（初期 64）
- バリデーション：1 以上、上限も設ける（例：512 など。値は提案してよい）

## 2) 変換モード（ラジオ）

- COVER（トリミングして必ず dst を埋める）
- CONTAIN（全体を収めて余白が出る可能性がある）
- STRETCH（任意。縦横別倍率で歪ませて埋める。MVP では省略可）

## 3) アンカー（3×3）

- COVER の場合：トリミング領域の位置決め基準
- CONTAIN の場合：縮小後の貼り付け位置の基準（余白が出る側が決まる）

## 4) ドット絵設定

- サンプリング（必須）：Nearest（ピクセル感維持のため）
  - 追加オプションとして Bilinear/Bicubic を置くなら理由を明記（推奨はしない）
- パレット数：8/16/32/64（初期 32）
- ディザ：OFF/ON（誤差拡散の有無）
- 背景色：CONTAIN で余白が出る場合に使用（透明/白/黒など）
- （任意）コントラスト/彩度などは拡張として提案してよい

## 5) プレビュー

- 入力画像プレビュー
- 出力プレビュー（拡大表示は Nearest で見せ、ぼやけないように）
- 設定変更時、一定間隔でデバウンスして再生成する（例：200ms 程度）
- 生成中はローディング表示

## 6) 操作ボタン

- 適用（生成結果を確定し、編集履歴に 1 ステップとして追加）
- キャンセル（状態を戻して閉じる）
- ダウンロード（PNG）

# 画像処理仕様（アルゴリズム：文章で明記）

## 共通

- 変換は「幾何変換（切り抜き/配置/リサイズ）」→「色数削減（量子化）」の順で行う。
- “ドット絵らしさ” の核心は
  1. Nearest で dst へリサイズ（ぼかさない）
  2. 色数削減（パレット化）
  3. 任意でディザ  
     の 3 点であることを明記する。

## COVER

- 入力画像と出力サイズの縦横比を比較し、余る方向（横余り or 縦余り）を決める。
- 出力比率になるように入力側の切り抜き矩形を決める。
- その切り抜き矩形の左上座標を、アンカー（3×3）に基づいて決める。
  - 例：中央アンカーなら余白を左右/上下に均等配分、左上アンカーなら切り抜き開始点を左上に寄せる、等。
- 切り抜いた領域を dst へ Nearest で縮小する。

## CONTAIN

- 入力全体が dst に収まる倍率で縮小する（拡大は基本しない方針でも可。方針を明記）
- 余白が出る場合、背景色で埋める（透明も可）
- アンカーに基づき、縮小後画像の貼り付け位置を決める。

## 量子化（色数削減）

- dst の全ピクセルを対象に「指定パレット数」に色を丸める。
- 実装方針を提案せよ：
  - 依存ライブラリ利用（推奨） or 自前（Median-cut / k-means のどちらか）
- ディザ ON の場合は誤差拡散を適用する（画質の特徴・副作用も説明する）

# 状態管理・アーキテクチャ

- UI 状態（width/height/mode/anchor/palette/dither/bgColor 等）と、  
   実処理（画像変換）の責務を分離する。
- 変換処理はキャンセル可能にする（連続変更で古い処理結果が反映されないように）。
- 大きい画像でも UI が固まらない設計（Worker、OffscreenCanvas、または分割処理等）を提案する。

# 入出力

- 入力：ユーザーがアップロードした画像（jpg/png/webp 等）
- 出力：PNG（透明対応）
- エクスポート前に最終プレビューと一致すること。

# 履歴（Undo/Redo）

- 「適用」は履歴 1 件として追加される。
- キャンセルは履歴に影響しない。

# エラーハンドリング

- 画像が読み込めない、サイズが不正、メモリ不足、処理中断などのケースを列挙し、UI での扱いを提案する。

# テスト要求（最低 12 個）

- COVER：各アンカーでトリミング位置が変わること（代表で複数）
- CONTAIN：余白位置がアンカー通りになること
- Nearest で拡大表示してもぼやけないこと（プレビューの CSS/描画設計含む）
- パレット数を減らすと色数が減ること（定性的でもよいが検証指標を提案）
- ディザ ON/OFF で見た目が変わること
- 連続操作でキャンセルが効き、古い結果が出ないこと
- 透明背景での PNG 出力が保たれること
- 大画像入力でも UI が固まらないこと（性能テスト観点）

# 受け入れ基準（Acceptance Criteria）

- 64×64 の PNG が生成できる。
- COVER/CONTAIN/アンカーの挙動が仕様通り。
- 出力プレビューとダウンロード結果が一致する。
- UI が固まらず、キャンセル可能である。
- Undo/Redo が正しく動く。

# 依頼するアウトプット形式（必須）

1. 機能仕様（UI と挙動）
2. データモデル（列挙体や設定オブジェクト）
3. 処理フロー（ステップ順）
4. パフォーマンス設計（非同期・キャンセル）
5. テスト計画（ケース一覧）
6. 実装タスク分解（MVP→ 拡張）

Gemini 3 Flash PreviewRan for 12s

lightbulbThought for 12 seconds

シニアフロントエンドエンジニアとして、ドット絵変換（Pixelate）機能の詳細設計を提示します。本設計は、パフォーマンスとユーザー体験（UX）を両立させ、かつ拡張性の高い構造を目指します。

---

### 1. 機能仕様（UI と挙動）

#### ダイアログ構成

- **サイズ入力エリア**: 出力解像度を決定する。
  - 幅・高さの入力フィールド。比率維持ボタン（リンク）を配置。
  - 推奨範囲：1px 〜 512px（ピクセルアートの密度として 512 を超える場合は「解像度の高い画像」となるため上限を設定）。
- **配置・変形設定**: 3x3 のグリッド形式のアンカーセレクターを配置。
  - **COVER**: dst を埋めるように src を切り抜く。中央アンカーが初期値。
  - **CONTAIN**: src 全体を収める。余白は背景色で塗りつぶす。
  - **STRETCH**: 縦横比を無視して dst に引き延ばす。
- **ドット絵変換パラメータ**:
  - **サンプリング**: 初期値は Nearest Neighbor（最近傍補間）。
  - **カラーパレット**: 8, 16, 32, 64 から選択（またはカスタム数値入力）。
  - **ディザリング**: チェックボックス（Floyd-Steinberg 法を想定）。
  - **背景色**: カラーピッカー（透明・白・黒のプリセット付き）。
- **プレビューエリア**:
  - 左に入力画像、右に出力結果（拡大表示）を配置。
  - 出力プレビューは「CSS での拡大」を行い、画像自体は生成された小サイズ（例：64x64）をそのまま表示。CSS の  image-rendering: pixelated  を適用し、ブラウザによるぼかしを防ぐ。

---

### 2. データモデル（設定オブジェクトの定義）

- **アンカー（AnchorType）**:
  - 垂直方向（Top, Middle, Bottom）と水平方向（Left, Center, Right）の組み合わせを定義。
- **変換モード（ResizeMode）**:
  - COVER, CONTAIN, STRETCH の 3 種類。
- **設定オブジェクト（PixelateSettings）**:
  - 出力解像度（数値ペア）
  - 変換モード（ResizeMode）
  - アンカー位置（AnchorType）
  - パレット数（数値）
  - ディザリング有効フラグ（真偽値）
  - 背景色（RGBA 形式）
  - サンプリングアルゴリズム（列挙体：Nearest 推奨）

---

### 3. 処理フロー（アルゴリズムのステップ）

変換は以下の 4 つのフェーズで順次実行する。

#### フェーズ A：幾何変換（Geometry Transformation）

1. **アスペクト比計算**: src と dst の比率を算出し、モードに応じた矩形を計算。
2. **COVER モード**:

   - src の縦横どちらかを基準に、dst と同じ比率になる矩形を src 内から切り出す。
   - 切り出す開始座標を、指定されたアンカーに基づいて決定（例：Bottom-Right なら右下に寄せる）。

3. **CONTAIN モード**:

   - src 全体が dst に収まる最大倍率を計算。
   - dst 内の貼り付け位置をアンカーに基づいて決定し、余った領域を背景色で埋める。

4. **リサイズ実行**: 計算されたソース矩形を抽出し、Nearest Neighbor 法を用いて dst の解像度（例：64x64）へピクセル情報を転写する。

#### フェーズ B：色量子化（Color Quantization）

1. **色の収集**: dst 全ピクセルの色情報をスキャン。
2. **パレット生成**:

   - Median-cut 法（中間値分割法）を用い、色の偏りに基づいて指定数（例：32 色）の代表色を抽出。
   - k-means 法よりも高速で、ドット絵に適したコントラストの強い色が残りやすいため Median-cut を推奨。

3. **近似色変換**: 各ピクセルの色を、生成されたパレット内で「最も距離が近い色（LAB 色空間での計算を推奨）」に置き換える。

#### フェーズ C：ディザリング（Dithering）

1. **誤差拡散**: ピクセルを左上から順に処理。
2. **計算**: 本来の色とパレット近似色との差（誤差）を算出。
3. **拡散**: その誤差を隣接する未処理ピクセル（右、左下、下、右下）に特定の重み付けで分配する。これにより、限られた色数で擬似的な階調を表現する。

#### フェーズ D：出力生成

1. **Canvas 描画**: 最終的なピクセル配列を OffscreenCanvas に描画。
2. **Blob 変換**: toBlob  メソッドを用いて PNG 形式に変換。

---

### 4. パフォーマンス設計

- **メインスレッドの解放**:
  - 画像処理（フェーズ A〜C）はすべて  **Web Worker**  上で実行する。
  - 画像データは  Transferable Objects（ArrayBuffer）として Worker に渡し、コピーコストを最小化する。
- **リアクティブ・プレビュー**:
  - 設定変更のたびに変換を走らせるが、200ms の  **デバウンス（Debounce）**  を挟む。
  - 新しい処理がリクエストされた際、前回の Worker 処理が進行中であれば、Worker.terminate()  またはフラグ管理により旧処理の結果を破棄する「処理のキャンセル」を実装する。
- **OffscreenCanvas の活用**:
  - ブラウザが対応していれば Worker 内で描画処理まで完結させ、メインスレッドへの通信回数を減らす。

---

### 5. テスト計画（ケース一覧）

1. **アンカー位置検証（COVER）**: Top-Left と Bottom-Right で、切り出される src の範囲が期待通り反転しているか。
2. **アンカー位置検証（CONTAIN）**: 小さい画像を CONTAIN で変換した際、余白がアンカーの反対側に出ているか。
3. **極端なアスペクト比**: 1000x10 の画像を 64x64 に変換した際の COVER/CONTAIN それぞれの挙動。
4. **NearestNeighbor の完全性**: プレビューを拡大した際、ピクセルの境界が 1px のボケもなく直線的に描画されているか。
5. **パレット数変化の感度**: パレット数を 8 にした際、明らかに 16 や 32 のときよりも色数が絞られ、ドット絵らしい「色の塊」ができているか。
6. **ディザリング視認**: グラデーションのある画像で、ディザ ON 時に砂嵐状のパターンが発生し、OFF 時に階調飛び（トーンジャンプ）が発生すること。
7. **透明度の維持**: 背景に透明部分がある画像を入力した際、ドット絵化後も PNG として透明が保持されているか。
8. **背景色合成**: 透明部分がある画像に対し、CONTAIN モードで背景色（赤など）を指定したとき、余白が正しく塗りつぶされるか。
9. **連続変更耐性**: スライダーを高速で動かした際、UI がフリーズせず、最後に止まった位置の設定が正しく反映されるか。
10. **大画像負荷テスト**: 4000x4000 ピクセル以上の画像を入力した際、Worker が正常に動作し、メインスレッドのスクロール等の操作が妨げられないか。
11. **リサイズ上限**: 512x512 の出力を指定した際のメモリ消費量と処理時間の許容範囲確認。
12. **再現性**: 同じ画像、同じ設定で 2 回実行した際、出力される Blob（バイナリ）が完全に一致するか。

---

### 6. 実装タスク分解

#### Phase 1: MVP（Minimum Viable Product）

- 基本ダイアログ UI の作成。
- Web Worker の基盤実装。
- フェーズ A（幾何変換）の Nearest Neighbor 実装。
- Median-cut 法によるパレット削減と近似色変換。
- PNG ダウンロード機能。

#### Phase 2: 品質向上

- フェーズ C（ディザリング）の実装。
- COVER/CONTAIN モードのアンカーロジック詳細化。
- デバウンスによるプレビューの最適化。
- image-rendering: pixelated  によるプレビュー UI の改善。

#### Phase 3: 拡張

- 背景色（RGBA）の柔軟な指定。
- パレットのカスタム生成（特定の色リストを優先する機能）。
- コントラスト・彩度の前処理フィルタの追加。
- Undo/Redo 履歴への統合（変換パラメータの Snapshot 保存）。

